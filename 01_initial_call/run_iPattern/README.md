## iPattern

### Installation

To request the iPattern package, please contact the corresponding author Dr. Stephen W. Scherer (stephen.scherer@sickkids.ca) of the [paper](https://www.ncbi.nlm.nih.gov/pubmed/20531469). For more information about iPattern, please refer to the [paper](https://www.ncbi.nlm.nih.gov/pubmed/?term=21552272).

After obtaining the package (e.g., ipn.0.581.tar.gz is the version we received), please follow the instructions in the iPattern tutorial enclosed in the package for installation and usage. Here we echo the installation instructions in their tutorial. 

#### Requirements
- R (2.7.1+)
  - The R "ppc" package – it can be downloaded from http://www-stat.stanford.edu/~tibs/PPC/Rdist/index.html
  - The R "cluster" package (1.15.2+)
- Python (2.5.5+)

#### Setup

- untar the package file with `tar -zvxf ipn.0.581.tar.gz`
- setup environment:
  - set up environment variable IPNBASE: `export IPNBASE='/path/to/ipn_0.581'`
  - set up environment variable PYTHONPATH: `PYTHONPATH=$PYTHONPATH:'/path/to/ipn_0.581/ipnlib'`

Note: the directory structure/name must be kept as it is. Changing the directory structure will break the iPattern pipeline, the pipeline finds all the necessary scripts based on IPNBASE and the directory structure. When PBS job submitting system is not available, you can use `–-noqsub` option to run iPattern sequentially.

Remark:

- In version 0.581, `${IPNBASE}/ipnlib/IpnFormat.py` will process the columns `Allele1 - Forward` and `Allele2 - Forward` in the final report (see the detailed decription of [data](https://github.com/HaoKeLab/ensembleCNV#data)). If only the `Allele1 - Top` and `Allele1 - Top` columns exist instead of the `Allele1 - Forward` and `Allele2 - Forward` columns in the final report, the users need to substitute `'Allele1 - Forward'` and `'Allele2 - Forward'` to the corresponding code `'Allele1 - Forward'` and `'Allele2 - Forward'` appearing in the `class IPNFormat` block of `${IPNBASE}/ipnlib/IpnFormat.py`.

- In version 0.581, two reference files `${IPNBASE}/ipn/known.cnvr.txt` and `${IPNBASE}/preprocess/ref_files/pq.txt` in the iPattern package are in hg18. We perpared a hg19 version [here](https://github.com/HaoKeLab/ensembleCNV/tree/master/01_initial_call/run_iPattern/ref_files_hg19) by [LiftOver](https://genome.ucsc.edu/cgi-bin/hgLiftOver). The users can substitute the two files when processing hg19 data. 

### Analysis workflow

#### Prepare auxiliary input files

In addition to the sample-wise final report files in `${WKDIR}/01_initial_call/run_iPattern/data`, which are supposed to have been generated by `${WKDIR}/01_initial_call/prepare_IPQ_input_file/finalreport_to_iPattern.pl`, three other auxiliary input files for iPattern can be generated as follows.

```sh
PROJECT_NAME=<project_name>
Rscript ${WKDIR}/01_initial_call/run_iPattern/prepare_input_files_for_iPattern.R ${WKDIR} ${PROJECT_NAME}
```

When the processing is completed, three files are supposed to be generated at  `${WKDIR}/01_initial_call/run_iPattern/data_aux`:

- `${PROJECT_NAME}_data_file.txt`: lists the absolute path to all the sample-wise final report files in `${WKDIR}/01_initial_call/run_iPattern/data`, so that iPattern knows where to find these data files.

- `${PROJECT_NAME}_gender_file.txt`: tab-delimited table including two columns (without column names in table header): Sample ID and Gender ("M" for male and "F" for female), which is generated based on `${WKDIR}/data/Samples_Table.txt` (see the detailed decription of [data](https://github.com/HaoKeLab/ensembleCNV#data)).

- `${PROJECT_NAME}_bad_samples.txt`: is used to list sample IDs to be excluded from iPattern analysis. We prepared an empty file where the users can type in the sample IDs to be excluded from the analysis if there is any.

#### Run iPattern

```sh
${IPNBASE}/preprocess/ilmn/ilmn_run.py \
--data-file-list   ${WKDIR}/01_initial_call/run_iPattern/data_aux/${PROJECT_NAME}_data_file.txt \
--gender-file      ${WKDIR}/01_initial_call/run_iPattern/data_aux/${PROJECT_NAME}_gender_file.txt \
--bad-sample-file  ${WKDIR}/01_initial_call/run_iPattern/data_aux/${PROJECT_NAME}_bad_samples.txt \
--experiment       $PROJECT_NAME \
--output-directory ${WKDIR}/01_initial_call/run_iPattern/results/ \
--do-log \
--do-cleanup \
--noqsub
```
When the analysis is completed, you will find two files, which will be used by ensembleCNV, in the directory `${WKDIR}/01_initial_call/run_iPattern/results`:
- `${PROJECT_NAME}_all_calls.txt`: raw CNV calls of all samples.
- `${PROJECT_NAME}_sample.stats.txt`: sample-level summary statistics.

Note: 
- All other parameters for `ilmn_run.py` are set by their default values.
- When the sample size of the project is large, the authors of iPattern recommend the whole dataset be split into batches with balanced sample size in order to control for the number of CNV calls per sample. The batches are analyzed by iPattern independently. In each batch (or iPattern run), a minimum of 90-96 samples (e.g. one 96-well plate of samples) and a maximum of 400 samples are recommended based on iPattern tutorial. Creating batches can be easily implemented by splitting `${PROJECT_NAME}_data_file.txt` into batch-level data files (e.g. `${PROJECT_NAME}_batch1_data_file.txt`, `${PROJECT_NAME}_batch2_data_file.txt`, etc.) with each batch having a batch-specific project name (e.g., `${PROJECT_NAME}_batch1`, `${PROJECT_NAME}_batch2`, etc.), while `${PROJECT_NAME}_gender_file.txt` and `${PROJECT_NAME}_bad_samples.txt` remains unchanged. When the analysis for all batches are completed, the batch-wise results (e.g., `${PROJECT_NAME}_batch*_all_calls.txt` and `${PROJECT_NAME}_batch*_sample.stats.txt`) will need to be combined into the final results for the whole project (e.g., `${PROJECT_NAME}_all_calls.txt` and `${PROJECT_NAME}_sample.stats.txt`).
