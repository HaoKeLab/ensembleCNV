## PennCNV

### Installation

To install PennCNV, please follow the detailed instructions (including trouble shooting) at the PennCNV [page](http://penncnv.openbioinformatics.org/en/latest/user-guide/install/). For more information about PennCNV, please refer to their original [PennCNV website](http://penncnv.openbioinformatics.org/en/latest/).

After installation, set up environment variable PENNCNV: `export PENNCNV='/path/to/penncnv'`

### Analysis workflow

Note: 

- PennCNV was originally designed to sequentially analyze one sample at a time. Please refer to [PennCNV website](http://penncnv.openbioinformatics.org/en/latest/) for how to perform a sequential analysis. Here, we provide scripts to run the analysis on multiple samples in parallel via job submitting system (one sample per job) in a cluster environment. 

- In the following steps (2) and (3), the scripts regarding job submission embraced by "##<<<... ##>>>..." in the scripts need to be specified based on your system.

We run PennCNV analysis with the following 5 steps:

(1) Prepare SNP.pfb and SNP.gcmodel files

See scripts in `step.1.prepare.files.sh` for details.






(2) Run PennCNV for each sample in parallel (through job submitting system on cluster)

Note: 

- In `step.2.run.PennCNV.jobs.R`, The scripts regarding job submission embraced by "##<<<... ##>>>..." need to be specified based on your system.

- For more information about CNV calling by PennCNV, please refer to the [page](http://penncnv.openbioinformatics.org/en/latest/user-guide/test/)

```sh 
Rscript ${WKDIR}/01_initial_call/run_PennCNV/step.2.run.PennCNV.jobs.R \
--penncnv ${PENNCNV} \                                  ## direct to ${PENNCNV}/bin/detect_cnv.pl
--data ${WKDIR}/01_initial_call/run_PennCNV/data \      ## generated with finalreport_to_PennCNV.pl
--wkdir ${WKDIR}/01_initial_call/run_PennCNV/results \  ## output directory
--pfb ${WKDIR}/01_initial_call/run_PennCNV/data_aux/SNP.pfb \
--gcmodel ${WKDIR}/01_initial_call/run_PennCNV/data_aux/SNP.gcmodel \
--hmm ${PENNCNV}/lib/hhall.hmm
```

When the analysis is completed, there will be subfolders named after sample IDs, each for one sample respectively, created in the directory `${WKDIR}/01_initial_call/run_PennCNV/results/res`. Within each sample subfolders, two files will be generated:
- `<Sample_ID>.log`: log file generated by `detect_cnv.pl`, information from which will be retrieved to generated sample-level summary statistics. 
- `<Sample_ID>.rawcnv`: raw CNV calls made by `detect_cnv.pl`.

(3) Check job status and resubmit failed jobs

Note: In `step.3.check.PennCNV.jobs.R`, The scripts regarding job submission embraced by "##<<<... ##>>>..." need to be specified based on your system.

```sh
Rscrip ${WKDIR}/01_initial_call/run_PennCNV/step.3.check.PennCNV.jobs.R \
--penncnv ${PENNCNV} \                                  ## direct to ${PENNCNV}/bin/detect_cnv.pl
--data ${WKDIR}/01_initial_call/run_PennCNV/data/ \     ## generated with finalreport_to_PennCNV.pl
--wkdir ${WKDIR}/01_initial_call/run_PennCNV/results \  ## output directory
--pfb ${WKDIR}/01_initial_call/run_PennCNV/data_aux/SNP.pfb \
--gcmodel ${WKDIR}/01_initial_call/run_PennCNV/data_aux/SNP.gcmodel \
--hmm ${PENNCNV}/lib/hhall.hmm
```
This step will screen if the jobs submitted for each sample in step (2) are successfully completed and resubmit failed jobs if there is any.


(4) Combine PennCNV results from each sample, including the content in .rawcnv and .log files
```sh
perl ${WKDIR}/01_initial_call/run_PennCNV/step.4.combine.PennCNV.res.pl \
--in_dir /path/to/results/ \
--out_dir /path/to/output/
```

(5) Merge closely adjacent CNVs and generate final results
```sh
Rscript ${WKDIR}/01_initial_call/run_PennCNV/step.5.clean.PennCNV.res.R \
-i /path/to/results/ \
-f /path/to/SNP.pfb \
-n file_name_of_combined_results ## [file_name_of_combined_results].rawcnv from step 4
```
